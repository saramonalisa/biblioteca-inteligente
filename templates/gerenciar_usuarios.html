{% extends "base.html" %}
{% load static %}
{% block title %}Gerenciar Usuários - Biblioteca Inteligente{% endblock title %}

{% block menu %}{% endblock menu %}

{% block content %}
<section class="min-vh-100 py-5" style="background: linear-gradient(135deg, #172155 0%, #1a2b6d 100%);">
  <div class="container py-4">
    <!-- Header -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="d-flex align-items-center mb-4">
          <a href="{{ request.META.HTTP_REFERER|default:'{% url "index" %}' }}" class="btn btn-outline-light rounded-circle me-3" 
             style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-arrow-left"></i>
          </a>
          <div>
            <h1 class="h2 fw-bold text-white mb-1">Gerenciar Usuários</h1>
            <p class="text-white-50 mb-0">Administre os usuários do sistema</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card border-0 shadow-sm h-100" style="background: rgba(255, 255, 255, 0.1);">
          <div class="card-body text-center text-white">
            <h2 class="display-6 fw-bold mb-0">{{ total_usuarios }}</h2>
            <p class="mb-0 opacity-75">Total</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card border-0 shadow-sm h-100" style="background: rgba(33, 150, 83, 0.2);">
          <div class="card-body text-center text-white">
            <h2 class="display-6 fw-bold mb-0">{{ usuarios_ativos }}</h2>
            <p class="mb-0 opacity-75">Ativos</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card border-0 shadow-sm h-100" style="background: rgba(255, 145, 77, 0.2);">
          <div class="card-body text-center text-white">
            <h2 class="display-6 fw-bold mb-0">{{ usuarios_staff }}</h2>
            <p class="mb-0 opacity-75">Administradores</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card border-0 shadow-sm h-100" style="background: rgba(77, 119, 255, 0.2);">
          <div class="card-body text-center text-white">
            <h2 class="display-6 fw-bold mb-0">{{ usuarios_regulares }}</h2>
            <p class="mb-0 opacity-75">Leitores</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <input type="text" class="form-control" placeholder="Buscar por nome, email ou usuário..." 
                       id="searchInput" value="{{ request.GET.q|default:'' }}">
              </div>
              <div class="col-md-3">
                <select class="form-select" id="roleFilter">
                  <option value="">Todos os tipos</option>
                  <option value="staff">Administrador</option>
                  <option value="regular">Leitor</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                  <option value="">Todos os status</option>
                  <option value="active">Ativo</option>
                  <option value="inactive">Inativo</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn w-100 fw-bold" style="background-color: #FF914D; color: white;" 
                        onclick="window.location='{% url 'cadastro' %}'">
                  <i class="fas fa-user-plus me-2"></i>Novo
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="row">
      <div class="col-12">
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
          <div class="card-body p-0">
            {% if usuarios %}
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light" style="background-color: rgba(255, 145, 77, 0.1);">
                    <tr>
                      <th scope="col" class="ps-4">
                        <i class="fas fa-user me-2" style="color: #FF914D;"></i>Usuário
                      </th>
                      <th scope="col">
                        <i class="fas fa-envelope me-2" style="color: #FF914D;"></i>Email
                      </th>
                      <th scope="col">
                        <i class="fas fa-phone me-2" style="color: #FF914D;"></i>Telefone
                      </th>
                      <th scope="col" class="text-center">
                        <i class="fas fa-user-tag me-2" style="color: #FF914D;"></i>Tipo
                      </th>
                      <th scope="col" class="text-center">
                        <i class="fas fa-calendar-alt me-2" style="color: #FF914D;"></i>Cadastro
                      </th>
                      <th scope="col" class="text-center">
                        <i class="fas fa-circle me-2" style="color: #FF914D;"></i>Status
                      </th>
                      <th scope="col" class="text-end pe-4">
                        <i class="fas fa-cogs me-2" style="color: #FF914D;"></i>Ações
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for usuario in usuarios %}
                    <tr class="hover-lift" data-role="{% if usuario.is_staff %}staff{% else %}regular{% endif %}" 
                        data-status="{% if usuario.is_active %}active{% else %}inactive{% endif %}">
                      <td class="ps-4">
                        <div class="d-flex align-items-center">
                          <div class="avatar me-3">
                            <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 40px; height: 40px; background: rgba(255, 145, 77, 0.1); color: #172155;">
                              <i class="fas fa-user fa-lg"></i>
                            </div>
                          </div>
                          <div>
                            <h6 class="mb-0 fw-bold">{{ usuario.nome|default:usuario.username }}</h6>
                            <small class="text-muted">@{{ usuario.username }}</small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span class="fw-medium">{{ usuario.email|default:"Não informado" }}</span>
                      </td>
                      <td>
                        <span class="fw-medium">{{ usuario.telefone|default:"Não informado" }}</span>
                      </td>
                      <td class="text-center">
                        {% if usuario.is_superuser %}
                          <span class="badge bg-danger rounded-pill py-2 px-3">
                            <i class="fas fa-crown me-1"></i>Super Admin
                          </span>
                        {% elif usuario.is_staff %}
                          <span class="badge bg-warning rounded-pill py-2 px-3">
                            <i class="fas fa-user-shield me-1"></i>Administrador
                          </span>
                        {% else %}
                          <span class="badge bg-primary rounded-pill py-2 px-3">
                            <i class="fas fa-user me-1"></i>Leitor
                          </span>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        <div class="text-dark fw-medium">{{ usuario.date_joined|date:"d/m/Y" }}</div>
                        <small class="text-muted">{{ usuario.date_joined|timesince }}</small>
                      </td>
                      <td class="text-center">
                        {% if usuario.is_active %}
                          <span class="badge bg-success rounded-pill py-2 px-3">
                            <i class="fas fa-check-circle me-1"></i>Ativo
                          </span>
                        {% else %}
                          <span class="badge bg-secondary rounded-pill py-2 px-3">
                            <i class="fas fa-times-circle me-1"></i>Inativo
                          </span>
                        {% endif %}
                      </td>
                      <td class="text-end pe-4">
                        <div class="btn-group" role="group">
                          <a href="{% url 'editar_usuario' usuario.id %}" 
                             class="btn btn-sm btn-outline-warning rounded-start-pill px-3" style="border-color: #FF914D; color: #FF914D;">
                            <i class="fas fa-edit me-1"></i>
                          </a>
                          {% if not usuario.is_superuser %}
                          <button class="btn btn-sm btn-outline-danger px-3" 
                                  onclick="toggleUserStatus({{ usuario.id }}, '{{ usuario.username }}', {{ usuario.is_active|lower }})">
                            <i class="fas {% if usuario.is_active %}fa-user-slash{% else %}fa-user-check{% endif %} me-1"></i>
                          </button>
                          {% if usuario.is_staff %}
                          <button class="btn btn-sm btn-outline-info px-3" 
                                  onclick="rebaixarUsuario({{ usuario.id }}, '{{ usuario.username }}')">
                            <i class="fas fa-user-minus me-1"></i>
                          </button>
                          {% else %}
                          <button class="btn btn-sm btn-outline-success px-3" 
                                  onclick="promoverUsuario({{ usuario.id }}, '{{ usuario.username }}')">
                            <i class="fas fa-user-plus me-1"></i>
                          </button>
                          {% endif %}
                          {% endif %}
                          <a href="{% url 'deletar_usuario' usuario.id %}" 
                             class="btn btn-sm btn-outline-secondary rounded-end-pill px-3" 
                             onclick="return confirm('Tem certeza que deseja excluir o usuário {{ usuario.username }}?')">
                            <i class="fas fa-trash-alt me-1"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <!-- Empty State -->
              <div class="text-center py-5">
                <div class="mb-4" style="color: #e0e0e0;">
                  <i class="fas fa-users fa-4x"></i>
                </div>
                <h5 class="text-muted mb-3">Nenhum usuário cadastrado</h5>
                <p class="text-muted mb-4">Comece adicionando o primeiro usuário ao sistema</p>
                <a href="{% url 'cadastro' %}" class="btn btn-lg fw-bold border-0" 
                   style="background-color: #FF914D; color: white; padding: 0.75rem 2rem; border-radius: 50px;">
                  <i class="fas fa-user-plus me-2"></i>Adicionar Primeiro Usuário
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    {% if usuarios %}
    <div class="row mt-4">
      <div class="col-12">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
              <a class="page-link" href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}{% endif %}" tabindex="-1">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>
            {% for i in page_obj.paginator.page_range %}
              {% if page_obj.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
              {% endif %}
            {% endfor %}
            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
              <a class="page-link" href="{% if page_obj.has_next %}?page={{ page_obj.next_page_number }}{% endif %}">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<style>
  .hover-lift {
    transition: all 0.2s ease;
  }
  
  .hover-lift:hover {
    transform: translateY(-2px);
    background-color: rgba(255, 145, 77, 0.05) !important;
  }
  
  .table > :not(caption) > * > * {
    padding: 1rem 0.5rem;
  }
  
  .avatar {
    min-width: 40px;
  }
  
  .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.75rem;
  }
  
  .btn-group .btn {
    border-radius: 0;
  }
  
  .btn-group .btn:first-child {
    border-top-left-radius: 50px;
    border-bottom-left-radius: 50px;
  }
  
  .btn-group .btn:last-child {
    border-top-right-radius: 50px;
    border-bottom-right-radius: 50px;
  }
  
  .rounded-start-pill {
    border-top-left-radius: 50px !important;
    border-bottom-left-radius: 50px !important;
  }
  
  .rounded-end-pill {
    border-top-right-radius: 50px !important;
    border-bottom-right-radius: 50px !important;
  }
  
  .page-link {
    color: #172155;
    border: 1px solid #dee2e6;
  }
  
  .page-item.active .page-link {
    background-color: #FF914D;
    border-color: #FF914D;
  }
</style>

<script>
  // Filter functionality
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const tableRows = document.querySelectorAll('tbody tr');
    
    function filterTable() {
      const search = searchInput.value.toLowerCase();
      const role = roleFilter.value;
      const status = statusFilter.value;
      
      tableRows.forEach(row => {
        let show = true;
        
        // Search filter
        if (search) {
          const userName = row.querySelector('h6').textContent.toLowerCase();
          const userEmail = row.querySelectorAll('td')[1].textContent.toLowerCase();
          const userUsername = row.querySelector('small').textContent.toLowerCase();
          if (!userName.includes(search) && !userEmail.includes(search) && !userUsername.includes(search)) {
            show = false;
          }
        }
        
        // Role filter
        if (role) {
          const userRole = row.getAttribute('data-role');
          if (userRole !== role) show = false;
        }
        
        // Status filter
        if (status) {
          const userStatus = row.getAttribute('data-status');
          if (userStatus !== status) show = false;
        }
        
        row.style.display = show ? '' : 'none';
      });
    }
    
    searchInput.addEventListener('input', filterTable);
    roleFilter.addEventListener('change', filterTable);
    statusFilter.addEventListener('change', filterTable);
  });
  
  function toggleUserStatus(userId, username, isActive) {
    const action = isActive ? 'desativar' : 'ativar';
    const message = `Tem certeza que deseja ${action} o usuário "${username}"?`;
    
    if (confirm(message)) {
      window.location.href = `/usuarios/toggle-status/${userId}/`;
    }
  }
  
  function promoverUsuario(userId, username) {
    if (confirm(`Deseja promover "${username}" a administrador?`)) {
      window.location.href = `/usuarios/promover/${userId}/`;
    }
  }
  
  function rebaixarUsuario(userId, username) {
    if (confirm(`Deseja rebaixar "${username}" a usuário regular?`)) {
      window.location.href = `/usuarios/rebaixar/${userId}/`;
    }
  }
</script>
{% endblock content %}