{% extends "base.html" %}
{% load static crispy_forms_tags %}
{% block title %}Editar Livro - Biblioteca Inteligente{% endblock title %}

{% block menu %}{% endblock menu %}

{% block content %}
<section class="min-vh-100 py-5 d-flex align-items-center" style="background: linear-gradient(135deg, #172155 0%, #1a2b6d 100%);">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-xl-10 col-lg-12">
        <!-- Header -->
        <div class="row mb-5">
          <div class="col-12">
            <div class="d-flex align-items-center mb-4">
              <a href="{{ request.META.HTTP_REFERER|default:'{% url "gerenciar_livros" %}' }}" 
                 class="btn btn-outline-light rounded-circle me-3" 
                 style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-arrow-left"></i>
              </a>
              <div>
                <h1 class="h2 fw-bold text-white mb-1">Editar Livro</h1>
                <p class="text-white-50 mb-0">Atualize as informações de "{{ livro.titulo }}"</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Card -->
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
          <div class="card-header border-0 pt-4 pb-3" style="background: linear-gradient(90deg, #FF914D 0%, #ffaa6d 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="fw-bold text-white mb-0">
                  <i class="fas fa-book-edit me-2"></i>Editar Livro
                </h4>
                <p class="text-white mb-0 opacity-75">ID: #{{ livro.id }} | Última atualização: {{ livro.updated_at|date:"d/m/Y H:i"|default:"-" }}</p>
              </div>
              <div class="text-end">
                <span class="badge bg-light text-dark py-2 px-3">
                  <i class="fas fa-book-open me-1"></i>
                  {{ livro.quantidade_emprestimos|default:0 }} empréstimo(s)
                </span>
              </div>
            </div>
          </div>
          
          <div class="card-body p-4 p-lg-5">
            <!-- Messages -->
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            {% endif %}
            
            <!-- Form Errors -->
            {% if form.errors %}
              <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                Por favor, corrija os erros abaixo.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endif %}
            
            <!-- Book Form -->
            <form method="post" class="needs-validation" enctype="multipart/form-data" novalidate>
              {% csrf_token %}
              
              <div class="row g-4">
                <!-- Book Cover Preview -->
                <div class="col-lg-3">
                  <div class="text-center mb-4">
                    <div class="book-cover-preview mb-3" style="width: 100%; height: 250px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #dee2e6;">
                      <div id="coverPreview" class="w-100 h-100 d-flex align-items-center justify-content-center">
                        {% if livro.capa %}
                          <img src="{{ livro.capa.url }}" 
                               class="img-fluid rounded" 
                               style="object-fit: cover; width: 100%; height: 100%;"
                               alt="Capa do livro {{ livro.titulo }}">
                        {% else %}
                          <div class="text-center">
                            <i class="fas fa-book fa-4x" style="color: #adb5bd;"></i>
                            <p class="text-muted mt-2 mb-0">Sem capa</p>
                            <small class="text-muted">JPG, PNG ou GIF</small>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="btn btn-outline-primary w-100 mb-2" for="id_capa">
                        <i class="fas fa-upload me-2"></i>Alterar Imagem
                      </label>
                      {{ form.capa }}
                      <small class="text-muted d-block mt-2">Tamanho máximo: 5MB</small>
                      {% if livro.capa %}
                      <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="removeCapa" name="remove_capa">
                        <label class="form-check-label small text-muted" for="removeCapa">
                          Remover imagem atual
                        </label>
                      </div>
                      {% endif %}
                    </div>
                    
                    <!-- Book Status -->
                    <div class="card border-0 shadow-sm mt-3" style="background-color: rgba(255, 145, 77, 0.05);">
                      <div class="card-body p-3">
                        <h6 class="fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-info-circle me-1"></i>Status do Livro
                        </h6>
                        <div class="mb-2">
                          <small class="text-muted d-block">Disponibilidade</small>
                          <span class="badge bg-success rounded-pill py-1 px-3">
                            <i class="fas fa-check-circle me-1"></i>Disponível
                          </span>
                        </div>
                        <div>
                          <small class="text-muted d-block">Criado em</small>
                          <small class="fw-medium">{{ livro.created_at|date:"d/m/Y"|default:"-" }}</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Book Details -->
                <div class="col-lg-9">
                  <div class="row g-4">
                    <!-- Title -->
                    <div class="col-md-12">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-heading me-2"></i>Título do Livro *
                        </label>
                        <div class="input-group">
                          <span class="input-group-text" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-book" style="color: #FF914D;"></i>
                          </span>
                          {{ form.titulo }}
                        </div>
                        {% if form.titulo.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.titulo.errors.0 }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    
                    <!-- Author and Publisher -->
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-user-edit me-2"></i>Autor *
                        </label>
                        <div class="input-group">
                          <span class="input-group-text" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-pen" style="color: #FF914D;"></i>
                          </span>
                          {{ form.autor }}
                        </div>
                        {% if form.autor.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.autor.errors.0 }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-building me-2"></i>Editora *
                        </label>
                        <div class="input-group">
                          <span class="input-group-text" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-print" style="color: #FF914D;"></i>
                          </span>
                          {{ form.editora }}
                        </div>
                        {% if form.editora.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.editora.errors.0 }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    
                    <!-- Genre and Classification -->
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-tags me-2"></i>Gênero *
                        </label>
                        <div class="input-group">
                          <span class="input-group-text" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-tag" style="color: #FF914D;"></i>
                          </span>
                          {{ form.genero }}
                        </div>
                        {% if form.genero.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.genero.errors.0 }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-sort-numeric-up me-2"></i>Classificação
                        </label>
                        <div class="input-group">
                          <span class="input-group-text" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-hashtag" style="color: #FF914D;"></i>
                          </span>
                          {{ form.classificacao }}
                        </div>
                        {% if form.classificacao.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.classificacao.errors.0 }}
                          </div>
                        {% endif %}
                        <small class="text-muted mt-1 d-block">
                          Ex: CDD, CDU, ou classificação interna
                        </small>
                      </div>
                    </div>
                    
                    <!-- Publication Year and ISBN -->
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-calendar-alt me-2"></i>Ano de Publicação *
                        </label>
                        <div class="input-group">
                          <span class="input-group-text" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-calendar" style="color: #FF914D;"></i>
                          </span>
                          {{ form.publicacao }}
                        </div>
                        {% if form.publicacao.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.publicacao.errors.0 }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-barcode me-2"></i>ISBN
                        </label>
                        <div class="input-group">
                          <span class="input-group-text" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-qrcode" style="color: #FF914D;"></i>
                          </span>
                          {{ form.isbn }}
                        </div>
                        {% if form.isbn.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.isbn.errors.0 }}
                          </div>
                        {% endif %}
                        <small class="text-muted mt-1 d-block">
                          Código ISBN-10 ou ISBN-13
                        </small>
                      </div>
                    </div>
                    
                    <!-- Synopsis -->
                    <div class="col-md-12">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-align-left me-2"></i>Sinopse
                        </label>
                        <div class="input-group">
                          <span class="input-group-text align-items-start" style="background-color: rgba(255, 145, 77, 0.1); border-color: #FF914D;">
                            <i class="fas fa-file-alt mt-2" style="color: #FF914D;"></i>
                          </span>
                          {{ form.sinopse }}
                        </div>
                        {% if form.sinopse.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.sinopse.errors.0 }}
                          </div>
                        {% endif %}
                        <small class="text-muted mt-1 d-block">
                          Descrição resumida do livro
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Additional Information -->
              <div class="card mt-4 border-0 shadow-sm" style="background-color: rgba(255, 145, 77, 0.05);">
                <div class="card-body">
                  <h6 class="fw-bold mb-3" style="color: #172155;">
                    <i class="fas fa-cog me-2"></i>Configurações Avançadas
                  </h6>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-box me-2"></i>Quantidade em Estoque *
                        </label>
                        <input type="number" class="form-control" name="quantidade" min="0" 
                               value="{{ livro.quantidade|default:1 }}" required>
                        <small class="text-muted mt-1 d-block">
                          Número de cópias disponíveis
                        </small>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-language me-2"></i>Idioma
                        </label>
                        <select class="form-select" name="idioma">
                          <option value="">Selecione...</option>
                          <option value="pt" {% if livro.idioma == 'pt' %}selected{% endif %}>Português</option>
                          <option value="en" {% if livro.idioma == 'en' %}selected{% endif %}>Inglês</option>
                          <option value="es" {% if livro.idioma == 'es' %}selected{% endif %}>Espanhol</option>
                          <option value="fr" {% if livro.idioma == 'fr' %}selected{% endif %}>Francês</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label class="form-label fw-bold mb-2" style="color: #172155;">
                          <i class="fas fa-ruler-combined me-2"></i>Número de Páginas
                        </label>
                        <input type="number" class="form-control" name="paginas" min="1" 
                               value="{{ livro.paginas|default:'' }}" placeholder="Ex: 250">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Change History -->
              {% if livro.history %}
              <div class="card mt-4 border-0 shadow-sm">
                <div class="card-body">
                  <h6 class="fw-bold mb-3" style="color: #172155;">
                    <i class="fas fa-history me-2"></i>Histórico de Alterações
                  </h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-borderless">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>Usuário</th>
                          <th>Alteração</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><small>{{ livro.created_at|date:"d/m/Y H:i" }}</small></td>
                          <td><small>Sistema</small></td>
                          <td><small class="text-success">Livro criado</small></td>
                        </tr>
                        <tr>
                          <td><small>{{ livro.updated_at|date:"d/m/Y H:i" }}</small></td>
                          <td><small>{{ request.user.username }}</small></td>
                          <td><small class="text-warning">Última edição</small></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              {% endif %}
              
              <!-- Submit Buttons -->
              <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="{% url 'gerenciar_livros' %}" 
                   class="btn btn-lg btn-outline-secondary me-md-2 rounded-3 fw-bold">
                  <i class="fas fa-times me-2"></i>Cancelar
                </a>
                <a href="{% url 'deletar_livro' livro.id %}" 
                   class="btn btn-lg btn-outline-danger me-md-2 rounded-3 fw-bold">
                  <i class="fas fa-trash-alt me-2"></i>Excluir
                </a>
                <button type="submit" class="btn btn-lg rounded-3 fw-bold text-white border-0 shadow" 
                        style="background-color: #FF914D;">
                  <i class="fas fa-save me-2"></i>Salvar Alterações
                </button>
              </div>
            </form>
          </div>
          
          <!-- Card Footer -->
          <div class="card-footer bg-light border-0 text-center py-3">
            <p class="mb-0 small text-muted">
              <i class="fas fa-info-circle me-1" style="color: #FF914D;"></i>
              Todos os campos marcados com * são obrigatórios
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-control, .form-select {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    height: 50px;
    transition: all 0.3s ease;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #FF914D;
    box-shadow: 0 0 0 0.25rem rgba(255, 145, 77, 0.25);
  }
  
  textarea.form-control {
    height: auto;
    min-height: 120px;
    resize: vertical;
  }
  
  .input-group-text {
    border-radius: 10px 0 0 10px;
    border: 2px solid #FF914D;
    border-right: none;
  }
  
  .book-cover-preview {
    transition: all 0.3s ease;
  }
  
  .book-cover-preview:hover {
    border-color: #FF914D !important;
  }
  
  .btn-outline-primary {
    border-color: #172155;
    color: #172155;
  }
  
  .btn-outline-primary:hover {
    background-color: #172155;
    border-color: #172155;
    color: white;
  }
  
  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
  }
  
  #id_capa {
    display: none;
  }
  
  .form-check-input:checked {
    background-color: #FF914D;
    border-color: #FF914D;
  }
  
  .form-check-input:focus {
    border-color: #FF914D;
    box-shadow: 0 0 0 0.25rem rgba(255, 145, 77, 0.25);
  }
  
  .card {
    transition: transform 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-3px);
  }
  
  .table-sm td, .table-sm th {
    padding: 0.5rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add Bootstrap classes to form fields
    const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="file"]');
    inputs.forEach(input => {
      if (input.type !== 'file') {
        input.classList.add('form-control');
      }
    });
    
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
      select.classList.add('form-select');
    });
    
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
      textarea.classList.add('form-control');
    });
    
    // Cover image preview
    const coverInput = document.getElementById('id_capa');
    const coverPreview = document.getElementById('coverPreview');
    const removeCapaCheckbox = document.getElementById('removeCapa');
    
    if (coverInput) {
      coverInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            coverPreview.innerHTML = `
              <img src="${e.target.result}" 
                   class="img-fluid rounded" 
                   style="object-fit: cover; width: 100%; height: 100%;"
                   alt="Nova capa do livro">
            `;
          };
          
          reader.readAsDataURL(file);
        }
      });
    }
    
    if (removeCapaCheckbox) {
      removeCapaCheckbox.addEventListener('change', function() {
        if (this.checked && !coverInput.files[0]) {
          coverPreview.innerHTML = `
            <div class="text-center">
              <i class="fas fa-book fa-4x" style="color: #adb5bd;"></i>
              <p class="text-muted mt-2 mb-0">Capa será removida</p>
              <small class="text-muted">JPG, PNG ou GIF</small>
            </div>
          `;
        }
      });
    }
    
    // ISBN formatting
    const isbnInput = document.getElementById('id_isbn');
    if (isbnInput) {
      isbnInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^\dX]/gi, '');
        
        // Format ISBN-13
        if (value.length <= 13) {
          if (value.length > 3) value = value.slice(0,3) + '-' + value.slice(3);
          if (value.length > 5) value = value.slice(0,5) + '-' + value.slice(5);
          if (value.length > 10) value = value.slice(0,10) + '-' + value.slice(10);
          if (value.length > 15) value = value.slice(0,15);
        }
        
        e.target.value = value;
      });
    }
    
    // Publication year validation
    const pubInput = document.getElementById('id_publicacao');
    if (pubInput) {
      pubInput.addEventListener('change', function() {
        const year = parseInt(this.value);
        const currentYear = new Date().getFullYear();
        
        if (year && (year < 1000 || year > currentYear + 1)) {
          alert('Por favor, insira um ano válido.');
          this.value = '';
          this.focus();
        }
      });
    }
    
    // Character counter for synopsis
    const sinopseTextarea = document.getElementById('id_sinopse');
    if (sinopseTextarea) {
      const counter = document.createElement('small');
      counter.className = 'text-muted mt-1 d-block text-end';
      counter.textContent = sinopseTextarea.value.length + '/1000 caracteres';
      
      sinopseTextarea.parentNode.appendChild(counter);
      
      sinopseTextarea.addEventListener('input', function() {
        const length = this.value.length;
        counter.textContent = `${length}/1000 caracteres`;
        
        if (length > 1000) {
          counter.style.color = '#dc3545';
        } else if (length > 900) {
          counter.style.color = '#ffc107';
        } else {
          counter.style.color = '#6c757d';
        }
      });
    }
    
    // Form validation
    (function () {
      'use strict'
      var forms = document.querySelectorAll('.needs-validation')
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            }
            form.classList.add('was-validated')
          }, false)
        })
    })()
    
    // Auto-save indicator
    const saveButton = document.querySelector('button[type="submit"]');
    const form = document.querySelector('form');
    let autoSaveTimeout;
    
    form.addEventListener('input', function() {
      clearTimeout(autoSaveTimeout);
      
      // Change button color to indicate unsaved changes
      if (saveButton) {
        saveButton.style.backgroundColor = '#ffaa00';
        saveButton.innerHTML = '<i class="fas fa-edit me-2"></i>Salvar Alterações*';
      }
      
      autoSaveTimeout = setTimeout(function() {
        // Optional: Auto-save functionality could be added here
        console.log('Auto-save triggered');
      }, 5000);
    });
    
    // Reset button on save
    if (saveButton) {
      saveButton.addEventListener('click', function() {
        this.style.backgroundColor = '#FF914D';
        this.innerHTML = '<i class="fas fa-save me-2"></i>Salvando...';
      });
    }
  });
</script>
{% endblock content %}